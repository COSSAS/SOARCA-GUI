package reporting

import (
	"encoding/json"
	"fmt"
	"soarca-gui/models/cacao"
	"soarca-gui/models/reporter"
	"soarca-gui/utils"
	"soarca-gui/views/components/alerts"
	"soarca-gui/views/components/cards"
	"soarca-gui/views/components/icons"
	"soarca-gui/views/components/indicators"
	"soarca-gui/views/layouts"
	"time"
)

templ ReportingDetailedView(executionReport reporter.PlaybookExecutionReport) {
	@layouts.DashboardLayout() {
		@headersection()
		@section(executionReport) {
			@playbookInfoCard(executionReport)
			@actionStepInfoCards(executionReport.StepResults)
		}
	}
}

templ ReportingDetailedView404(errors utils.Errors) {
	@layouts.DashboardLayout() {
		@headersection()
		@section404(errors)
	}
}

templ section404(errors utils.Errors) {
	@cards.Card(utils.Class("relative shadow-lg rounded-lg p-6 mb-6")) {
		<span class="text-md mb-8 font-bold text-gray-800">Not Found: </span>
		<span>error occured</span>
		<hr class="mt-2"/>
		if errors.Has("backend") {
			<div class="mt-2">
				@alerts.ErrorAlert(errors.Get("backend").Error())
			</div>
		}
	}
}

templ headersection() {
	@cards.Card(utils.Class("relative bg-gradient-to-r from-blue-600 to-fuchsia-500 shadow-md rounded-lg p-2 mb-2  dark:bg-c-dark-slate-background/ dark:bg-none")) {
		<div clas="h-10 flex items-center justify-center ">
			<button onclick="history.back()" class="flex w-1/2 items-center justify-center gap-x-2 rounded-lg border bg-white px-5 py-2 text-sm text-gray-700 transition-colors duration-200 hover:bg-gray-100 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-200 dark:hover:bg-gray-800 sm:w-auto">
				<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-5 rtl:rotate-180">
					<path stroke-linecap="round" stroke-linejoin="round" d="M6.75 15.75L3 12m0 0l3.75-3.75M3 12h18"></path>
				</svg>
				<span>Go back</span>
			</button>
		</div>
	}
}

templ section(executionReport reporter.PlaybookExecutionReport) {
	@cards.Card(utils.Class("relative shadow-lg rounded-lg p-6 mb-6"), reportingShadowColorStatus(executionReport.Status)) {
		{ children... }
	}
}

templ playbookInfoCard(executionReport reporter.PlaybookExecutionReport) {
	@statusIndicator(executionReport.Status)
	<span class="text-md font-bold text-gray-800 dark:text-c-dark-slate-text mb-8">{ executionReport.Name }</span>
	<hr class="mt-2"/>
	<div class="mb-6">
		<table class="table-auto text-sm text-gray-600">
			<tbody>
				<tr>
					<th class="pr-4 text-left font-semibold dark:text-c-dark-slate-text">Execution ID:</th>
					<td class="dark:text-white">{ executionReport.ExecutionId }</td>
				</tr>
				<tr>
					<th class="font-semibold text-left pr-4 dark:text-c-dark-slate-text">Description:</th>
					<td class="dark:text-white">{ executionReport.Description }</td>
				</tr>
				<tr>
					<th class="font-semibold text-left pr-4 dark:text-c-dark-slate-text">Started:</th>
					<td class="dark:text-white">{ executionReport.Started.Format(time.ANSIC) }</td>
				</tr>
				<tr>
					<th class="pr-4 text-left font-semibold dark:text-c-dark-slate-text">Ended:</th>
					<td class="dark:text-white">{ executionReport.Ended.Format(time.ANSIC) }</td>
				</tr>
				<tr>
					<th class="pr-4 text-left font-semibold dark:text-c-dark-slate-text ">Duration:</th>
					<td class="dark:text-white">{ formatDuration(executionReport.Started, executionReport.Ended) }</td>
				</tr>
				<tr>
					<th class="pr-4 text-left font-semibold dark:text-c-dark-slate-text ">Status:</th>
					<td class="dark:text-white">{  executionReport.StatusText }</td>
				</tr>
			</tbody>
		</table>
	</div>
}

templ statusIndicator(status string) {
	<div class="absolute right-0 top-0 p-2 pr-4">
		@indicators.ReportingStatusTag(status)
	</div>
}

templ expander() {
	<div x-data="{ reportsOpen: false }">
		<div @click="reportsOpen = !reportsOpen" class="mx-auto mb-5 mt-32 flex w-full items-center overflow-hidden border-b text-c-dark-slate-text-dark md:mt-0">
			<div class="w-10 transform border-r px-2 transition duration-300 ease-in-out" :class="{'rotate-90': reportsOpen,' -translate-y-0.0': !reportsOpen }">
				<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6">
					<path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path>
				</svg>
			</div>
			<div class="flex items-center px-2">
				<div class="mx-3">
					<button class="hover:underline">See more details</button>
				</div>
			</div>
		</div>
		<div
			class="flex w-full transform border-b transition duration-300 ease-in-out md:p-0"
			x-cloak
			x-show="reportsOpen"
			x-collapse
			x-collapse.duration.500ms
		>
			{ children... }
		</div>
	</div>
}

templ expandActionInfoCard(stepResults reporter.StepExecutionReport) {
	<div class="mb-6">
		<div class="mt-2 overflow-x-auto rounded-lg bg-gray-100 dark:bg-c-dark-slate-border p-2">
			if len(stepResults.Variables ) > 0 {
				for name, stepResult := range stepResults.Variables {
					@formatCacaoVariables(name, stepResult)
				}
			} else {
				@alerts.WarningAlert("No Cacao Variable found")
			}
		</div>
	</div>
}

templ formatCacaoVariables(name string, result cacao.Variable) {
	<div class="mb-6">
		<span class="text-md font-semi-bold mb-8 dark:text-c-blue-light-backgroud text-gray-800">Name:</span>
		<span>{ name }</span>
		<hr class="mt-2"/>
		<table class="table-auto text-sm text-gray-600">
			<tbody>
				<tr>
					<th class="pr-4 text-left font-semibold">Type:</th>
					<td>{ result.Type }</td>
				</tr>
			</tbody>
		</table>
		<pre class="rounded-md bg-gray-200 p-2 text-xs">
			<code class="no-shadow language-json rounded-lg">
				{ string(prettyPrint(result.Value)) }
			</code>
		</pre>
	</div>
}

templ actionStepInfoCard(stepResult reporter.StepExecutionReport) {
	//default card messes with the reporting indicator at top right, so we have a custom card. 
	<div { utils.CreateClassAttrs("relative border bg-gray-50 rounded-lg p-4 mb-4 dark:bg-c-dark-slate-navbar-background", reportingBorderColorStatus(stepResult.Status))... }>
		@statusIndicator(stepResult.Status)
		<span class="text-md font-bold text-gray-800 dark:text-c-dark-slate-text mb-8">{ stepResult.Name }</span>
		<hr class="mt-2"/>
		<table class="table-auto text-sm text-gray-600">
			<tbody>
				<tr>
					<th class="font-semibold text-left pr-4 dark:text-white">Execution ID:</th>
					<td class="dark:text-white">{ stepResult.ExecutionId }</td>
				</tr>
				<tr>
					<th class="font-semibold text-left pr-4 dark:text-white">Description:</th>
					<td class="dark:text-white">{ stepResult.Description }</td>
				</tr>
				<tr>
					<th class="font-semibold text-left pr-4 dark:text-white">Started:</th>
					<td class="dark:text-white">{ stepResult.Started.Format(time.ANSIC) }</td>
				</tr>
				<tr>
					<th class="pr-4 text-left font-semibold dark:text-white">Ended:</th>
					<td class="dark:text-white">{ stepResult.Ended.Format(time.ANSIC) }</td>
				</tr>
				<tr>
					<th class="pr-4 text-left font-semibold dark:text-white">Duration:</th>
					<td class="dark:text-white">{ formatDuration(stepResult.Started, stepResult.Ended) }</td>
				</tr>
				<tr>
					<th class="pr-4 text-left font-semibold dark:text-white">Status:</th>
					<td class="dark:text-white">{ stepResult.StatusText }</td>
				</tr>
				<tr>
					<th class="pr-4 text-left font-semibold dark:text-white">Executed by:</th>
					<td class="dark:text-white">{ stepResult.ExecutedBy }</td>
				</tr>
			</tbody>
		</table>
		<hr class="mt-2"/>
		{ children... }
	</div>
}

templ actionStepInfoCards(stepResults map[string]reporter.StepExecutionReport) {
	@cards.Card(utils.Class("bg-blue-200 p-4 rounded-lg")) {
		<span class="inline-flex items-center">
			@icons.NewIcon("zap").SetSize("12").InsertIcon("text-blue-600 ")
			<p class="mb-1 ml-1 text-sm text-blue-600">
				Found: { fmt.Sprint(len(stepResults)) } actions 
			</p>
		</span>
		@viewSelector(timelineView(stepResults), detailedView(stepResults))
	}
}

templ timelineView(stepResults map[string]reporter.StepExecutionReport) {
	<div class="relative m-4">
		<ol class="border-s border-gray-200  dark:border-gray-700">
			for _, stepResult := range stepResults {
				<li class="mb-5 ms-6">
					<span class="absolute -start-3 flex h-6 w-6 items-center justify-center rounded-full bg-white dark:bg-c-dark-slate-card ring-8 ring-white dark:ring-c-dark-slate-card">
						@indicators.ReportingStatusTagNoText(stepResult.Status)
					</span>
					<h3 class="flex items-center mb-1 text-lg font-semibold text-gray-900 dark:text-white">{ stepResult.Name }</h3>
					<time class="block mb-2 text-sm font-normal leading-none text-gray-400 dark:text-gray-500">Started: { stepResult.Started.Format(time.ANSIC) }</time>
					<time class="block mb-2 text-sm font-normal leading-none text-gray-400 dark:text-gray-500">Duration: {  formatDuration(stepResult.Started, stepResult.Ended) }</time>
				</li>
			}
		</ol>
	</div>
}

templ detailedView(stepResults map[string]reporter.StepExecutionReport) {
	for _, stepResult := range stepResults {
		@actionStepInfoCard(stepResult) {
			@expander() {
				@expandActionInfoCard(stepResult)
			}
		}
	}
}

templ viewSelector(timeline templ.Component, detailed templ.Component) {
	<div x-data="{ selectedTab: 'timeline' }" class="w-full">
		<div @keydown.right.prevent="$focus.wrap().next()" @keydown.left.prevent="$focus.wrap().previous()" class="flex gap-2 overflow-x-auto border-b border-slate-300 dark:border-slate-700" role="tablist" aria-label="tab options">
			<button @click="selectedTab = 'timeline'" :aria-selected="selectedTab === 'timeline'" :tabindex="selectedTab === 'timeline' ? '0' : '-1'" :class="selectedTab === 'timeline' ? 'font-bold text-blue-700 border-b-2 border-blue-700 dark:border-blue-600 dark:text-blue-600' : 'text-slate-700 font-medium dark:text-slate-300 dark:hover:border-b-slate-300 dark:hover:text-white hover:border-b-2 hover:border-b-slate-800 hover:text-black'" class="flex h-min items-center gap-2 px-4 py-2 text-sm" type="button" role="tab" aria-controls="tabpanelTimeline">
				@icons.NewIcon("bar-chart").InsertIcon("")
				Timeline View
			</button>
			<button @click="selectedTab = 'detailed'" :aria-selected="selectedTab === 'detailed'" :tabindex="selectedTab === 'detailed' ? '0' : '-1'" :class="selectedTab === 'detailed' ? 'font-bold text-blue-700 border-b-2 border-blue-700 dark:border-blue-600 dark:text-blue-600' : 'text-slate-700 font-medium dark:text-slate-300 dark:hover:border-b-slate-300 dark:hover:text-white hover:border-b-2 hover:border-b-slate-800 hover:text-black'" class="flex h-min items-center gap-2 px-4 py-2 text-sm" type="button" role="tab" aria-controls="tabpanelDetailed">
				@icons.NewIcon("info").InsertIcon("")
				Detailed View
			</button>
		</div>
		<div class="px-2 py-4 text-slate-700 dark:text-slate-300">
			<div x-show="selectedTab === 'timeline'" id="tabpanelTimeline" role="tabpanel" aria-label="timeline">
				@timeline
			</div>
			<div x-show="selectedTab === 'detailed'" id="tabpanelDetailed" role="tabpanel" aria-label="detailed">
				@detailed
			</div>
		</div>
	</div>
}

func prettyPrint(data string) []byte {
	var prettyJSON map[string]interface{}
	if err := json.Unmarshal([]byte(data), &prettyJSON); err != nil {
		return []byte(fmt.Sprintf("Failed to generate JSON: %s", err))
	}
	returnString, err := json.MarshalIndent(prettyJSON, "", "  ")
	if err != nil {
		return []byte(fmt.Sprintf("Failed to generate JSON: %s", err))
	}
	return returnString
}

func formatDuration(t1 time.Time, t2 time.Time) string {

	duration := t2.Sub(t1)

	if duration.Milliseconds() >= 0 {
		return duration.Round(time.Millisecond).String()
	} else {
		return ""
	}

}

func reportingBorderColorStatus(status string) func(*templ.Attributes) {

	switch status {
	case "successfully_executed":
		return utils.Class("border-emerald-500")
	case "failed":
		return utils.Class("border-red-500")
	case "ongoing":
		return utils.Class("border-orange-500")
	case "server_side_error":
		return utils.Class("border-red-500")
	case "client_side_error":
		return utils.Class("border-red-500")
	case "timeout_error":
		return utils.Class("border-amber-500")
	case "exception_condition_error":
		return utils.Class("border-purple-500")
	default:
		return utils.Class("")
	}
}

func reportingShadowColorStatus(status string) func(*templ.Attributes) {

	switch status {
	case "successfully_executed":
		return utils.Class("shadow-emerald-200")
	case "failed":
		return utils.Class("shadow-red-200")
	case "ongoing":
		return utils.Class("shadow-orange-200")
	case "server_side_error":
		return utils.Class("shadow-red-200")
	case "client_side_error":
		return utils.Class("shadow-red-200")
	case "timeout_error":
		return utils.Class("shadow-amber-200")
	case "exception_condition_error":
		return utils.Class("shadow-purple-200")
	default:
		return utils.Class("")
	}
}
